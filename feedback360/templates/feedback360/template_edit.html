{% extends 'feedback360/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-pencil-square me-2"></i>
                Редактирование шаблона: {{object.name}}
            </h4>
        </div>
        <div class="card-body">
            <form method="post" novalidate id="template-form">
                {% csrf_token %}

                {{ formset.management_form }}

                <div class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">Название шаблона *</label>
                        {{ form.name|add_class:"form-control"|attr:"required" }}
                        <div class="invalid-feedback">
                            Пожалуйста, укажите название шаблона
                        </div>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        {{ form.is_active|add_class:"form-check-input" }}
                        <label class="form-check-label">{{ form.is_active.label }}</label>
                    </div>
                </div>

                <!-- Контейнер для вопросов -->
                <div id="questions-formset">
                    <h5 class="mb-3 border-bottom pb-2">
                        <i class="bi bi-question-circle me-2"></i>
                        Вопросы шаблона
                    </h5>

                    <!-- Существующие вопросы -->
                    {% for form in formset %}
                    <div class="question-form">
                        {{ form.DELETE|add_class:"d-none" }}
                        <div class="card mb-3{% if form.DELETE.value %} d-none{% endif %}">
                            <div class="card-body">
                                <div class="question-counter">Вопрос {{ forloop.counter }}</div>
                                {{ form.id }}
                                {{ form.sort_order|add_class:"d-none" }}
                                {{ form.scale_min|attr:"data-scale:min" }}
                                {{ form.scale_max|attr:"data-scale:max" }}

                                <div class="row g-3 align-items-center">
                                    <div class="col-auto">
                                        <button type="button"
                                                class="btn btn-danger btn-sm delete-question"
                                                title="Удалить вопрос">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>

                                    <div class="col-md-8">
                                        {{ form.text|add_class:"form-control"|attr:"required" }}
                                        <div class="invalid-feedback">
                                            Текст вопроса обязателен
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        {{ form.answer_type|add_class:"form-select" }}
                                        {% if form.answer_type.errors %}
                                            <div class="text-danger small mt-1">{{ form.answer_type.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Прототип вопроса (Исправлено!) -->
                    <div class="question-form prototype d-none">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="question-counter">Вопрос <span>0</span></div>
                                <input type="hidden" name="template_questions-__prefix__-id">
                                <input type="hidden" name="template_questions-__prefix__-DELETE" id="id_template_questions-__prefix__-DELETE">
                                {{ formset.empty_form.sort_order|add_class:"d-none" }} <!-- Добавлено -->
                                {{ formset.empty_form.scale_min|attr:"data-scale:min" }}
                                {{ formset.empty_form.scale_max|attr:"data-scale:max" }}

                                <div class="row g-3 align-items-center">
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-danger btn-sm delete-question">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>

                                    <div class="col-md-8">
                                        {{ formset.empty_form.text|add_class:"form-control"|attr:"required" }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ formset.empty_form.answer_type|add_class:"form-select" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка добавления -->
                    <div class="d-flex justify-content-start mt-4">
                        <button type="button"
                                id="add-question"
                                class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>
                            Добавить вопрос
                        </button>
                    </div>
                </div>

                <!-- Кнопки сохранения -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-success btn-lg me-2">
                        <i class="bi bi-save me-2"></i>
                        Сохранить
                    </button>
                    <a href="{% url 'template_list' %}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle me-2"></i>
                        Отмена
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}


{% block extra_css %}
<style>
    .question-form textarea.form-control {
        height: 60px !important;
        min-height: 60px;
        resize: vertical;
        line-height: 1.4;
    }

    .question-counter {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 0.8rem;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('template-form');
    if (!form) return;

    // Элементы управления
    const questionsContainer = document.getElementById('questions-formset');
    const addButton = document.getElementById('add-question');
    const errorContainer = document.createElement('div');
    errorContainer.className = 'alert alert-danger mb-4 d-none';
    errorContainer.innerHTML = `<h5 class="alert-heading">Ошибки заполнения:</h5><div class="errors-list"></div>`;
    form.prepend(errorContainer);

    // Основная функция обновления порядка
    const updateQuestionOrder = () => {
        const visibleQuestions = Array.from(
            questionsContainer.querySelectorAll('.question-form:not(.prototype):not(.d-none)')
        );

        visibleQuestions.forEach((question, index) => {
            const orderInput = question.querySelector('[name$="-sort_order"]');
            const questionNumber = index + 1;

            if (orderInput) {
                orderInput.value = questionNumber;
                question.querySelector('.question-counter').textContent = `Вопрос ${questionNumber}`;
                console.log(`Updated question ${index + 1}: sort_order=${orderInput.value}`); // Debug
            }
        });

        // Форсируем изменение TOTAL_FORMS
        const totalFormsInput = form.querySelector('[name$="-TOTAL_FORMS"]');
        if (totalFormsInput) {
            totalFormsInput.value = visibleQuestions.length;
            console.log(`TOTAL_FORMS updated to: ${totalFormsInput.value}`); // Debug
        }
    };

    // Добавление нового вопроса
    const addNewQuestion = () => {
        const prototype = document.querySelector('.question-form.prototype');
        if (!prototype) return;

        const newQuestion = prototype.cloneNode(true);
        newQuestion.classList.remove('prototype', 'd-none');

        // Заменяем __prefix__ на текущее количество вопросов
        newQuestion.innerHTML = newQuestion.innerHTML.replace(/__prefix__/g,
            document.querySelectorAll('.question-form:not(.prototype)').length
        );

        questionsContainer.insertBefore(newQuestion, addButton.parentElement);
        initQuestionHandlers(newQuestion);
        updateQuestionOrder();
    };

    // Удаление вопроса
    function deleteQuestion(questionForm) {
        const questionId = questionForm.querySelector('[name$="-id"]')?.value;
        const templateId = {{ object.id }};

        // Проверяем, есть ли уже запрос на удаление для этого вопроса
        if (questionForm.dataset.deleting === 'true') return;
        questionForm.dataset.deleting = 'true';

        // Для новых, несохраненных вопросов - просто удаляем из DOM
        if (!questionId) {
            questionForm.remove();
            updateQuestionOrder();
            return;
        }

        // Показываем индикатор загрузки
        const deleteBtn = questionForm.querySelector('.delete-question');
        const originalHtml = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
        deleteBtn.disabled = true;

        // Отправляем запрос на удаление
        fetch(`/templates/${templateId}/questions/${questionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                questionForm.remove();
                updateQuestionOrder();
            } else {
                showError(data.message || 'Неизвестная ошибка при удалении');
            }
        })
        .catch(error => {
            showError(error.message);
        })
        .finally(() => {
            deleteBtn.innerHTML = originalHtml;
            deleteBtn.disabled = false;
            delete questionForm.dataset.deleting;
        });
    }

    // Функция для показа ошибки (чтобы избежать дублирования)
    let isErrorShowing = false;
    function showError(message) {
        if (isErrorShowing) return;
        isErrorShowing = true;

        alert('Ошибка при удалении: ' + message);

        setTimeout(() => {
            isErrorShowing = false;
        }, 100);
    }

    // Инициализация обработчиков
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.delete-question').forEach(btn => {
            btn.addEventListener('click', function() {
                const questionForm = this.closest('.question-form');
                deleteQuestion(questionForm);
            });
        });
    });

    // Для динамически добавленных элементов используйте делегирование событий
    document.getElementById('questions-formset').addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-question') ||
            e.target.closest('.delete-question')) {
            const btn = e.target.classList.contains('delete-question') ?
                       e.target : e.target.closest('.delete-question');
            const questionForm = btn.closest('.question-form');
            deleteQuestion(questionForm);
        }
    });


    // Инициализация обработчиков
    document.querySelectorAll('.delete-question').forEach(btn => {
        btn.addEventListener('click', function() {
            const questionForm = this.closest('.question-form');
            deleteQuestion(questionForm);
        });
    });

    // Инициализация обработчиков для вопроса
    const initQuestionHandlers = (questionElement) => {
        // Обработчик типа ответа
        const typeSelect = questionElement.querySelector('select[name$="-answer_type"]');
        if (typeSelect) {
            typeSelect.addEventListener('change', () => {
                const scaleInputs = questionElement.querySelectorAll('[data-scale]');
                scaleInputs.forEach(input => {
                    input.value = typeSelect.value === 'scale' ? '1' : '';
                });
            });
        }

        // Кнопка удаления
        const deleteBtn = questionElement.querySelector('.delete-question');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Вы уверены, что хотите удалить этот вопрос?')) {
                    deleteQuestion(questionElement);
                }
            });
        }
    };

    // Валидация формы
    const validateForm = (e) => {
        e.preventDefault();
        let isValid = true;
        const errors = [];

        // Сбрасываем предыдущие ошибки
        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        errorContainer.classList.add('d-none');

        // Проверка названия шаблона
        const nameInput = form.querySelector('[name="name"]');
        if (!nameInput?.value?.trim()) {
            errors.push('Название шаблона обязательно');
            nameInput?.classList.add('is-invalid');
            isValid = false;
        }

        // Проверка вопросов
        const questions = form.querySelectorAll('.question-form:not(.d-none)');
        if (questions.length === 0) {
            errors.push('Добавьте хотя бы один вопрос');
            isValid = false;
        }

        questions.forEach((question, index) => {
            const textArea = question.querySelector('textarea');
            const answerType = question.querySelector('select')?.value;

            // Проверка текста вопроса
            if (!textArea?.value?.trim()) {
                errors.push(`Вопрос ${index + 1}: Текст обязателен`);
                textArea?.classList.add('is-invalid');
                isValid = false;
            }

            // Проверка шкалы
            if (answerType === 'scale') {
                const scaleMin = question.querySelector('[data-scale="min"]');
                const scaleMax = question.querySelector('[data-scale="max"]');

                if (!scaleMin || !scaleMax ||
                    scaleMin.value !== "1" ||
                    scaleMax.value !== "5") {
                    errors.push(`Вопрос ${index + 1}: Некорректные значения шкалы`);
                    isValid = false;
                }
            }
        });

        // Вывод ошибок
        if (!isValid) {
            errorContainer.querySelector('.errors-list').innerHTML =
                errors.map(e => `<div>• ${e}</div>`).join('');
            errorContainer.classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            form.submit();
        }
    };

    // Инициализация всех элементов
    const init = () => {
        // Инициализация существующих вопросов
        document.querySelectorAll('.question-form:not(.prototype)').forEach(initQuestionHandlers);

        // Кнопка добавления
        addButton.addEventListener('click', addNewQuestion);

        // Обработчик формы
        form.addEventListener('submit', validateForm);

        // Первоначальное обновление порядка
        updateQuestionOrder();
    };

    console.log("Current sort_order values:",
        Array.from(document.querySelectorAll('[name$="-sort_order"]'))
            .map(input => input.value)
    );
    init();
});
</script>
{% endblock extra_js %}